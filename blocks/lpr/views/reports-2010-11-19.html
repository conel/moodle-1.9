<div class="block_lpr">
    <?php require_once("{$CFG->dirroot}/blocks/lpr/views/js/reports.js.php"); ?>
    <script type="text/javascript" src="<?php echo $CFG->wwwroot;?>/blocks/lpr/views/js/mootools.js"></script>
    <script type="text/javascript" src="<?php echo $CFG->wwwroot;?>/blocks/lpr/views/js/calendar.compat.js"></script>
    <form method="get" action="<?php echo $CFG->wwwroot; ?>/blocks/lpr/actions/reports.php?>">
        <div class="date_selector">
            <?php
            // add all the current page params as hidden values
            foreach($_GET as $name => $value) {
                // except the ones we're setting in this form
                if($name != 'start_date' && $name != 'end_date') {
                    echo "<input type='hidden' name='$name' value='$value' />";
                }
            } ?>
            <label for="start_date">Start Date:</label>
            <input type="text" id="start_date" name="start_date" value="<?php echo $start_date; ?>" />
            <label for="end_date">End Date:</label>
            <input type="text" id="end_date" name="end_date" value="<?php echo $end_date; ?>" />
            <input type="submit" value="Update" />
            <script type="text/javascript">
                window.addEvent(
                    'domready',
                    function() {
                    	reportsCal = new Calendar({
                    		start_date: { start_date: 'd/m/Y' },
                    		end_date: { end_date: 'd/m/Y' }
                    		}, { pad: 1, direction: -1, classes: ['lpr_calendar']}
                    	);//, navigation: 2
                    });
            </script>
        </div>
    </form>
    <div id="category_browser" class="category_browser">
        <a class="sitename" href="<?php echo $CFG->wwwroot; ?>/blocks/lpr/actions/reports.php?start_date=<?php echo $start_date; ?>&amp;end_date=<?php echo $end_date; ?>">
            <?php echo $SITE->shortname; ?>
        </a>
        <ul>
            <?php recursively_print_categories($categories, $start_date, $end_date); ?>
        </ul>
    </div>
    <div class="category_report">
        <table>
            <tr>
                <th>
                    <?php echo get_string('metric', 'block_lpr'); ?>
                </th>
                <th>
                    <?php echo get_string('average', 'block_lpr'); ?>
                </th>
            </tr>
            <tr>
                <td class="half">
                    <?php echo get_string('attendance', 'block_lpr'); ?>
                </td>
                <td class="half">
                    <?php
                    if(!empty($atten->attendance)) {
                        echo round($atten->attendance, 2).'% ('.map_attendance($atten->attendance).')';
                    } ?>
                </td>
            </tr>
            <tr>
                <td class="half">
                    <?php echo get_string('punctuality', 'block_lpr'); ?>
                </td>
                <td class="half">
                    <?php
                    if(!empty($atten->punctuality)) {
                        echo round($atten->punctuality, 2).'% ('.map_attendance($atten->punctuality).')';
                    } ?>
                </td>
            </tr>
            <?php
            foreach($indicators as $ind) { ?>
                <tr>
                    <td class="half">
                        <?php echo $ind->indicator; ?>
                    </td>
                    <td class="half">
                        <?php echo !empty($answers[$ind->id]) ? round($answers[$ind->id]->answer, 2) : null; ?>
                    </td>
                </tr>
                <?php
            } ?>
        </table>
        <div>
            <?php
            if(!empty($learner_id)) {
                echo "Statistics for <i>".fullname($learner)."</i> in course <i>{$course->shortname}</i>.<br/>";
                echo "Averages computed across {$lpr_count} LPR(s), ";
            } elseif(!empty($course_id)) {
                echo "<i>{$course->shortname}</i> has {$learner_count} students.<br/>";
                echo "Averages computed across {$lpr_count} LPR(s), for {$lpr_learners} student(s), ";
            } else {
                $displayname = empty($category) ? $SITE->shortname : $category->name;
                echo "<i>{$displayname}</i> comprises {$cat_count} course categories, "
                    ."which contain a total of {$course_count} courses and {$learner_count} students, of which ";

                $url = "{$CFG->wwwroot}/blocks/lpr/actions/list_incomplete.php?".http_build_query($_GET);
                echo ($unfinished_count > 0) ? "<a class='risk' href='{$url}'>{$unfinished_count} have incomplete PLPs</a>.<br/>" : "0 have incomplete PLPs.<br/>";

                echo "Averages computed across {$lpr_count} LPR(s), for {$lpr_learners} "
                    ."student(s) in {$lpr_courses} course(s), ";
            }
            $url = "{$CFG->wwwroot}/blocks/lpr/actions/list.php?risk=1&amp;".http_build_query($_GET);
            echo "of which ".(($lpr_risks > 0) ? "<a href='{$url}' class='risk'>{$lpr_risks} are at risk</a>" : "0 are at risk").".";
            ?>
            <br/><br/>
        </div>
        <?php
        if(!empty($learner)) { ?>
            <h2 class="main">All Courses</h2>
            <table>
                <tr>
                    <th>
                        <?php echo get_string('metric', 'block_lpr'); ?>
                    </th>
                    <th>
                        <?php echo get_string('average', 'block_lpr'); ?>
                    </th>
                </tr>
                <tr>
                    <td class="half">
                        <?php echo get_string('attendance', 'block_lpr'); ?>
                    </td>
                    <td class="half">
                        <?php
                        if(!empty($atten_learner->attendance)) {
                            echo round($atten_learner->attendance, 2).'% ('.map_attendance($atten_learner->attendance).')';
                        } ?>
                    </td>
                </tr>
                <tr>
                    <td class="half">
                        <?php echo get_string('punctuality', 'block_lpr'); ?>
                    </td>
                    <td class="half">
                        <?php
                        if(!empty($atten_learner->punctuality)) {
                            echo round($atten_learner->punctuality, 2).'% ('.map_attendance($atten_learner->punctuality).')';
                        } ?>
                    </td>
                </tr>
                <?php
                foreach($indicators as $ind) { ?>
                    <tr>
                        <td class="half">
                            <?php echo $ind->indicator; ?>
                        </td>
                        <td class="half">
                            <?php echo !empty($answers_learner[$ind->id]) ? round($answers_learner[$ind->id]->answer, 2) : null; ?>
                        </td>
                    </tr>
                    <?php
                } ?>
            </table>
            <?php
            echo "Statistics for <i>".fullname($learner)."</i> in all courses.<br/>";
            echo "Averages computed across {$lpr_count_learner} LPRs, ";
            $params = $_GET;
            unset($params['course_id']);
            $url = "{$CFG->wwwroot}/blocks/lpr/actions/list.php?risk=1&amp;".http_build_query($params);
            echo "of which ".(($lpr_risks_all > 0) ? "<a href='{$url}' class='risk'>{$lpr_risks_all} are at risk</a>" : "0 are at risk").".";?>
            <br/><br/>
            <?php
        } elseif(!empty($students)) { ?>
            <table>
                <tr>
                    <th><?php echo get_string('students'); ?></th>
                </tr>
                <?php
                foreach($students as $student) { ?>
                    <tr>
                        <td>
                            <a href="<?php echo $CFG->wwwroot; ?>/blocks/lpr/actions/reports.php?category_id=<?php echo $category_id;?>&amp;course_id=<?php echo $course_id; ?>&amp;learner_id=<?php echo $student->id; ?>&amp;start_date=<?php echo $start_date; ?>&amp;end_date=<?php echo $end_date; ?>">
                                <?php echo fullname($student); ?>
                            </a>
                        </td>
                    </tr>
                    <?php
                } ?>
            </table>
            <?php
        } elseif(!empty($courses)) { ?>
            <table>
                <tr>
                    <th><?php echo get_string('courses'); ?></th>
                </tr>
                <?php
                foreach($courses as $c) { ?>
                    <tr>
                        <td>
                            <a href="<?php echo $CFG->wwwroot; ?>/blocks/lpr/actions/reports.php?category_id=<?php echo $category_id;?>&amp;course_id=<?php echo $c->id; ?>&amp;start_date=<?php echo $start_date; ?>&amp;end_date=<?php echo $end_date; ?>">
                                <?php echo $c->fullname; ?>
                            </a>
                        </td>
                    </tr>
                    <?php
                } ?>
            </table>
            <?php
        } ?>
    </div>
    <div class="clearer"></div>
    <script type="text/javascript">
        //<![CDATA[
        window.onload = function() {
            restore_category_menu(<?php echo $category_id; ?>);
        }
        //]]>
    </script>
</div>
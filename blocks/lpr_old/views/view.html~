<div class="block_lpr">
    <form action="<?php echo $CFG->wwwroot;?>/blocks/lpr/actions/save.php?id=<?php echo $lpr->id; ?>&amp;ilp=<?php echo $ilp; ?>" method="post">
        <table>
            <tr>
                <th colspan="5">
                    <?php echo (!empty($category->name) ? $category->name.'<br/>' : '').$course->fullname; ?>
                </th>
            </tr>
            <tr>
                <td class="quater">
                    <?php echo get_string('learner', 'block_lpr').': '; ?>
                </td>
                <td class="quater">
                    <?php
                    if(!empty($learner)) { ?>
                        <a href="<?php echo $CFG->wwwroot;?>/user/view.php?id=<?php echo $learner->id; ?>&amp;course=<?php echo $course->id; ?>">
                            <?php echo fullname($learner); ?>
                        </a>
                        <?php
                    } ?>
                </td>
               <td class="quater <?php echo ($can_write && $editable) ? 'required' : ''; ?>">
                    <?php echo get_string('lecturer', 'block_lpr').': '; ?>
                    <?php
                    if($can_write && $editable) { ?>
                        <img class="req" src="<?php echo $CFG->wwwroot; ?>/theme/conel/pix/req.gif" alt="Required field" title="Required field"/>
                        <?php
                    } ?>
                </td>
                <td class="quater" colspan="2">
                    <?php
                    if($can_write && $editable) {
                        echo choose_from_menu($lecturers, 'lecturer_id', $lpr->lecturer_id, '&nbsp;');
                        if(in_array('lecturer_id', $errors)) {
                            echo '<div class="required">You must select a value.</div>';
                        }
                    } else {
                        if(!empty($lecturer)) { ?>
                            <a href="<?php echo $CFG->wwwroot;?>/user/view.php?id=<?php echo $lecturer->id; ?>&amp;course=<?php echo $course->id; ?>">
                                <?php echo fullname($lecturer); ?>
                            </a>
                            <?php
                        }
                    } ?>
                </td>
            </tr>
			<tr>
				<td class="quater <?php echo ($can_write && $editable) ? 'required' : ''; ?>">
					<?php echo get_string('term', 'block_lpr').': '; ?>
				</td>
				<td class="quater" colspan="2">
				<?php
					if($can_write && $editable) {
                        echo choose_from_menu($terms, 'term_id', $current_term, '&nbsp;');
                        if(in_array('term_id', $errors)) {
                            echo '<div class="required">You must select a value.</div>';
                        }
                    } else {
                        echo (!empty($lpr_term)) ?  $lpr_term->term_name : 'undefined';
                    }
				?>
				</td>
			</tr>
            <tr>
                <td>
                    <?php //echo get_string('assessmentgroup', 'block_lpr'); ?>
					Reporting on unit/course:
                </td>
                <td colspan="4">
                    <?php echo (!empty($category) ? $category->name . ' / ' : '').$course->fullname; ?>
                </td>
            </tr>
			<tr>
				<!--<td>Assessment Description:</td>-->
				<td>Other units/courses reporting on:</td>
				<td colspan="4">
					<?php
					if($can_write && $editable) {
						print_textarea(true, 5, 80, 0, 0, 'unit_desc', $lpr->unit_desc);
					} else {
						echo !empty($lpr->unit_desc) ? $lpr->unit_desc : 'None.';
					} ?>
				</td>
			</tr>
			<tr>
				<td>
					<?php 
					echo get_string('modules','block_lpr').':';
					?>
				</td>
				<td> 
					Description:
				</td>				
				<td> 
					Attendence:
				</td>
				<td colspan="2"> 
					Punctuality:
				</td>
			</tr>			
			<?php
            echo '<pre>';
            var_dump($modules);
            echo '</pre>';

			if(!empty($modules)) {
				foreach ($modules as $module) { ?>
					<tr>
						<td>
							<?php echo $module->module_code; ?>
						</td>
						<td>
							<?php echo $module->module_desc; ?>
						</td>
						<td>
							<?php 
							$avg=($module->marks_present/$module->marks_total)*100;
							echo round($avg,2)."% (".map_attendance($avg).")"; ?>
						</td>					
						<td>
							<?php 
							$avg2=($module->punct_positive/$module->marks_present)*100;
							echo round($avg2,2)."% (".map_attendance($avg2).")"; ?>
						</td>	
						<td>
							<?php
							if($editable){?>
								<input type="hidden"	value="0" name="modules[<?php echo $module->id; ?>]" /> 
								<input type="checkbox" value="1" name="modules[<?php echo $module->id; ?>]" <?php echo ($module->selected == 1) ? 'checked="checked"' : null; ?> />
								<?php
							} ?>
						</td>
					</tr>
				<?php
				}
			} else { ?>
				<tr>
					<td colspan="5"> 
						<?php echo ($editable) ? "None available" : "None selected";  // TODO replace with token in lang file ?>
					</td>
				</tr>
				<?php 
			} ?>
			<tr>
                <td colspan="2" class="half">
                    <?php echo "Average"; /*get_string('attendance', 'block_lpr');*/ ?>
                </td>
                <td>
                    <?php
                    if(!empty($atten->attendance)) {
                        echo round($atten->attendance, 2).'% ('.map_attendance($atten->attendance).')';
                    } ?>
                </td>
                <td colspan="2">
                    <?php
                    if(!empty($atten->punctuality)) {
                        echo round($atten->punctuality, 2).'% ('.map_attendance($atten->punctuality).')';
                    } ?>
                </td>
            </tr>
            <?php
            foreach($indicators as $ind) { ?>
                <tr>
                    <td colspan="2" class="half <?php echo ($can_write && $editable) ? 'required' : ''; ?>">
                        <?php echo $ind->indicator; ?>
                        <?php
                        if($can_write && $editable) { ?>
                            <img class="req" src="<?php echo $CFG->wwwroot; ?>/theme/conel/pix/req.gif" alt="Required field" title="Required field"/>
                            <?php
                        } ?>
                    </td>
                    <td colspan="3" class="half">
                        <?php
                        if($can_write && $editable) {
                            $options = array();
                            // generate the list of options from $ind->bound
                            for($i=1; $i<=$ind->bound; $i++) {
                                $options[$i] = $i;
                            }
                            echo choose_from_menu($options, "ind[{$ind->id}]",
                                !empty($answers[$ind->id]) ? $answers[$ind->id]->answer : null,
                                '&nbsp;', null, null, true, false, 0, '',
                                false, false, 'ind_select');
                            if(in_array($ind->id, $errors)) {
                                echo '<span class="required">You must select a value.</span>';
                            }
                        } else {
                            echo !empty($answers[$ind->id]) ? $answers[$ind->id]->answer : null;
                        }
                        ?>
                    </td>
                </tr>
                <?php
            } ?>
            <tr>
                <th colspan="5">
                    <?php echo get_string('comments', 'block_lpr'); ?>
                </th>
            </tr>
            <tr>
                <td colspan="5">
                    <?php
                    if($can_write && $editable) {
                        print_textarea(true, 20, 80, 0, 0, 'comments', $lpr->comments);
                        use_html_editor('comments');
                    } else {
                        echo !empty($lpr->comments) ? $lpr->comments : 'None.';
                    } ?>
                </td>
            </tr>
        </table>
        <?php
        if($can_write) { ?>
            <div class="buttons">
                <?php
                if($editable) { ?>
                    <input type="submit" name="name" value="Save"/>
                    <input type="button" onclick="javascript:window.location = '<?php echo $CFG->wwwroot;?>/blocks/lpr/actions/view.php?id=<?php echo $lpr->id; ?>&amp;ilp=<?php echo $ilp; ?>'" name="cancel" value="Cancel"/>
                    <?php
                } else { ?>
                    <input type="button" onclick="javascript:window.location = '<?php echo $CFG->wwwroot;?>/blocks/lpr/actions/edit.php?id=<?php echo $lpr->id; ?>&amp;ilp=<?php echo $ilp; ?>'" name="edit" value="Edit" />
                    <?php
                } ?>
            </div>
            <?php
        } ?>
    </form>
</div>
<?php
if($can_write && $editable) { ?>
    <div class="mform">
        <div class="fdescription required">
            There are required fields in this form marked
            <img src="<?php echo $CFG->wwwroot; ?>/theme/conel/pix/req.gif" alt="Required field"/>
        </div>
    </div>
    <?php
} ?>
